name: Deploy static site

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Expand partials (SSI-style includes)
        run: |
          node -e "
          const fs=require('fs'), path=require('path');
          function expand(file, anchor){
            let html=fs.readFileSync(file,'utf8');
            html=html.replace(/<!--#include file=\\"(.*?)\\" -->/g,(m,p)=>{
              const inc=path.resolve(anchor,p);
              return fs.existsSync(inc)?fs.readFileSync(inc,'utf8'):m;
            });
            fs.writeFileSync(file,html);
          }
          function walk(dir){
            for(const f of fs.readdirSync(dir)){
              const p=path.join(dir,f);
              const st=fs.statSync(p);
              if(st.isDirectory()) walk(p);
              else if(p.endsWith('.html')){
                const rel=p.includes(path.sep+'wiki'+path.sep) ? 'site/wiki' : 'site';
                expand(p,rel);
              }
            }
          }
          walk('site');
          "
      - uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
