name: pages
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # If you have a build step, add it here.
      - name: Sanity check: UTF-8 & no mojibake
        shell: bash
        run: |
          set -euo pipefail
          ROOT="site"
          bad_meta=0
          while IFS= read -r -d '' f; do
            head -c 2048 "$f" | grep -iq '<meta charset="utf-8"' || bad_meta=$((bad_meta+1))
          done < <(find "$ROOT" -type f \( -name '*.html' -o -name '*.htm' \) -print0)
          if grep -R -n -E 'â€”|â€“|â€˜|â€™|â€œ|â€�|Â|â€¦' "$ROOT"; then
            echo "::error ::Found cp1252 mojibake in built HTML"; exit 1; fi
          if [ "$bad_meta" -gt 0 ]; then
            echo "::warning ::$bad_meta HTML files missing early <meta charset=\"utf-8\">"; fi

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
